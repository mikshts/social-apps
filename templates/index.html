{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags  link rel para logo sang website-->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=bookmark_heart" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=bookmark_heart" />
    <title>{% block title %}PerfectMatch{% endblock %}</title>
    <!-- IconScout CDN -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet" />

    <link
      rel="stylesheet"
      href="https://unicons.iconscout.com/release/v2.1.6/css/unicons.css" />
    <!-- Stylesheet -->
    <link rel="stylesheet" href="{%static 'assets/css/style.css' %}" />
    <link rel="stylesheet" href="{%static 'assets/css/stories.css' %}" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=delete" />
    <link
      rel="stylesheet"
      href="https://unicons.iconscout.com/release/v2.1.6/css/unicons.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=chat" />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0&icon_names=chat" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=add_diamond" />
  </head>
  <body>
    <!--navbar reused -->
    {% include 'navbar.html' %}

    <!-------------------------------- MAIN ----------------------------------->
    <main>
      <style>
        .material-symbols-outlined {
          font-variation-settings: "FILL" 0, "wght" 0, "GRAD" 0, "opsz" 24;
        }
      </style>

      <div class="container">
        <!----------------- LEFT -------------------->
        <div class="left">
          <a class="profile">
            <div
              class="user"
              style="display: flex; align-items: center; gap: 10px">
              <div class="profile-photo" style="position: relative">
                <img
                  src="{{ user.profile.profileimg.url|default:'/static/blank_profile_picture.png' }}"
                  alt="{{ user.username }}'s profile picture" />
              </div>
            </div>

            <div class="name">
              <h4 style="display: flex; align-items: center; gap: 6px">
                {{ user.username }} {% if user.profile.is_online %}
                <span class="online-dot"></span>
                {% elif user.profile.is_offline %}
                <span class="offline-dot"></span>
                {% endif %}
              </h4>
              <small class="text-muted">{{ user.profile.bio }}</small>
            </div>
          </a>

          <!----------------- SIDEBAR -------------------->
          <div class="sidebar">
            <a class="menu-item active" href="{%url 'index'%}">
              <span><i class="uil uil-home"></i></span>
              <h3>Home</h3>
            </a>
            <a class="menu-item" href="{%url 'explore'%}">
              <span><i class="uil uil-compass"></i></span>
              <h3>Explore</h3>
            </a>
            <a class="menu-item" id="notifications">
              <span
                ><i class="uil uil-bell"
                  ><small class="notification-count">9+</small></i
                ></span
              >
              <h3>Notification</h3>
              <!--------------- NOTIFICATION POPUP --------------->
              <div class="notifications-popup">
                <div>
                  <div class="profile-photo">
                    <img src="{%static 'assets/images/profile-2.jpg'%}" />
                  </div>
                  <div class="notification-body">
                    <b>Keke Benjamin</b> accepted your friend request
                    <small class="text-muted">2 Days Ago</small>
                  </div>
                </div>
                <div>
                  <div class="profile-photo">
                    <img src="{%static 'assets/images/profile-3.jpg'%}" />
                  </div>
                  <div class="notification-body">
                    <b>John Doe</b> commented on your post
                    <small class="text-muted">1 Hour Ago</small>
                  </div>
                </div>
                <div>
                  <div class="profile-photo">
                    <img src="{%static 'assets/images/profile-4.jpg'%}" />
                  </div>
                  <div class="notification-body">
                    <b>Marry Oppong</b> and <b>283 Others</b> liked your post
                    <small class="text-muted">4 Minutes Ago</small>
                  </div>
                </div>
                <div>
                  <div class="profile-photo">
                    <img src="{%static 'assets/images/profile-5.jpg'%}" />
                  </div>
                  <div class="notification-body">
                    <b>Doris Y. Lartey</b> commented on a post you are tagged in
                    <small class="text-muted">2 Days Ago</small>
                  </div>
                </div>
                <div>
                  <div class="profile-photo">
                    <img src="{%static 'assets/images/profile-6.jpg'%}" />
                  </div>
                  <div class="notification-body">
                    <b>Keyley Jenner</b> commented on a post you are tagged in
                    <small class="text-muted">1 Hour Ago</small>
                  </div>
                </div>
                <div>
                  <div class="profile-photo">
                    <img src="{%static 'assets/images/profile-7.jpg'%}" />
                  </div>
                  <div class="notification-body">
                    <b>Jane Doe</b> commented on your post
                    <small class="text-muted">1 Hour Ago</small>
                  </div>
                </div>
              </div>
              <!--------------- END NOTIFICATION POPUP --------------->
            </a>

            <a class="menu-item" href="{%url 'bookmarks'%}">
              <span><i class="uil uil-bookmark"></i></span>
              <h3>Bookmarks</h3>
            </a>
            <a class="menu-item" href="{%url 'analytics'%}">
              <span><i class="uil uil-chart-line"></i></span>
              <h3>Analytics</h3>
            </a>
            <a class="menu-item" id="theme">
              <span><i class="uil uil-palette"></i></span>
              <h3>Theme</h3>
            </a>
            <a class="menu-item" href="{%url 'settings'%}">
              <span><i class="uil uil-setting"></i></span>
              <h3>Setting</h3>
            </a>
          </div>
          <!----------------- END OF SIDEBAR -------------------->
        </div>

        <!----------------- MIDDLE -------------------->
        <div class="middle">
          <!----------------- STORIES -------------------->
          <!----------------- STORIES -------------------->
          <div class="stories">
            <!-- Story item (can be repeated with different images) -->
            <div
              class="story"
              onclick="openStory(0)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(0)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img
                  src="{{ user.profile.profileimg.url|default:'/static/blank_profile_picture.png' }}"
                  alt="Profile" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(0)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(0)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(0)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(0)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(1)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(2)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(3)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center/cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <div
              class="story"
              onclick="openStory(4)"
              style="
                background: url('{% static 'assets/images/story-1.jpg' %}')
                  no-repeat center center / cover;
              ">
              <div class="profile-photo">
                <img src="{% static 'assets/images/profile-8.jpg' %}" />
              </div>
              <p class="name">Your Story</p>
            </div>

            <!-- Repeat similar structure for more stories -->
          </div>
          <!-- Story Viewer -->
          <!-- Story Viewer -->
          <div id="storyViewer" class="story-viewer hidden">
            <div class="story-container">
              <div class="progress-bar">
                <div class="progress"></div>
              </div>
              <div class="story-info">
                <img
                  src="{%static 'assets/images/maico.jpg'%}"
                  alt="Profile"
                  class="story-profile" />
                <div class="story-text">
                  <span class="story-username">John Maico</span>
                  <span class="story-timezone">1h ago · UTC+8</span>
                </div>
              </div>

              <img
                id="fullStoryImage"
                src=""
                alt="Story Image"
                class="story-image" />

              <div class="story-actions">
                <button class="action-btn close-bottom-btn">✖</button>
                <button class="action-btn message-bottom-btn">
                  Send a Thought
                </button>
                <button class="action-btn like-bottom-btn">❤️</button>
              </div>

              <span class="close-story" onclick="closeStory()">✖</span>
              <span class="prev-story" onclick="prevStory()">⟨</span>
              <span class="next-story" onclick="nextStory()">⟩</span>
            </div>
          </div>
          <!----------------- END OF STORIES -------------------->

          <!--CREATE POST-------------------------------->
          <!-- Trigger Section -->
          <div class="dating-create-post-trigger" id="dating-open-modal">
            <div class="profile-photo">
              <img
                src="{{ user.profile.profileimg.url|default:'/static/blank_profile_picture.png' }}"
                alt="Profile" />
            </div>

            <div class="post-input-wrapper">
              <span class="animated-prompt">
                What's on your mind,
                <span class="username-highlight">{{ user.username }}</span>?
              </span>
              <input type="text" name="readonlyField" placeholder="" readonly />
            </div>
          </div>

          <!-- Modal -->
          <div class="dating-modal-overlay" id="dating-post-modal">
            <div class="dating-modal-box">
              <span class="dating-close-btn">&times;</span>
              <h3>Create Post</h3>
              <form
                id="create-post-form"
                data-url="{% url 'create_post_from_index' %}"
                enctype="multipart/form-data">
                {% csrf_token %}
                <textarea
                  name="caption"
                  placeholder="Write a caption..."></textarea>

                <div class="dating-file-upload">
                  <label class="dating-upload-label">
                    Upload Photo
                    <input type="file" name="image" accept="image/*" />
                  </label>
                </div>

                <div class="dating-post-actions">
                  <button type="submit" class="dating-submit-btn">Post</button>
                </div>
              </form>
            </div>
          </div>

          {% if messages %}
          <div id="flash-bubble-container" class="flash-bubble-container">
            {% for message in messages %}
            <div class="flash-bubble {{ message.tags }}">{{ message }}</div>
            {% endfor %}
          </div>
          {% endif %}

          <!----------------- FEEDS -------------------->
          <!-- ----------------- FEEDS -------------------- -->
          <div class="feeds" id="posts-list">
            {% for post in posts %} {% include "posts/post_single.html" %}
            {%endfor %}
          </div>
          <div
            id="loading-indicator"
            style="display: none; text-align: center; margin: 1em">
            <span>Loading...</span>
          </div>
        </div>
        <!----------------- END OF FEEDS -------------------->
        <!----------------- RIGHT -------------------->

        <div class="right">
          <!------- MESSAGES ------->
          <!-- Message Notifications Icon -->

          <!-- Message Button (Floating Bottom Right) -->
          <div id="message-float-button" class="menu-item">
            <i class="uil uil-envelope-alt">
              <small class="notification-count">6</small>
            </i>
            <h3>Messages</h3>
          </div>

          <div id="chat-section" class="chat-popup hidden">
            <div class="messages">
              <div class="heading">
                <h4>Messages</h4>
                <i class="uil uil-edit"></i>
              </div>

              <!-- Search Bar -->
              <div class="search-bar">
                <i class="uil uil-search"></i>
                <input
                  type="search"
                  placeholder="Search messages"
                  id="message-search" />
              </div>

              <!-- Category Tabs -->
              <div class="category">
                <h6 class="active">Primary</h6>
                <h6>General</h6>
                <h6 class="message-requests">Requests (7)</h6>
              </div>

              <!-- Message List -->
              <div class="message-list" id="message-list-container">
                {% include 'partials/message_list.html' %}
              </div>
            </div>
          </div>

          <!-- Chat Box Container (When a message is clicked) -->

          <!-- Popup: Chat Window (Initially Hidden) -->
          <div id="chat-popup" class="chat-popup hidden"></div>

          <script>
            document.addEventListener("DOMContentLoaded", function () {
              const chatSection = document.getElementById("chat-section");
              const chatPopup = document.getElementById("chat-popup");

              // Toggle chat section
              document
                .getElementById("message-float-button")
                .addEventListener("click", () => {
                  chatSection.classList.toggle("hidden");
                  chatPopup.classList.add("hidden");
                });

              // Message list click (event delegation)
              const messageList = document.getElementById(
                "message-list-container"
              );
              if (messageList) {
                messageList.addEventListener("click", function (e) {
                  const messageEl = e.target.closest(".message");
                  if (messageEl) {
                    const receiverId = messageEl.dataset.userId;
                    fetch(`/chat/${receiverId}/`)
                      .then((res) => res.text())
                      .then((html) => {
                        chatPopup.innerHTML = html;
                        chatPopup.classList.remove("hidden");
                        chatSection.classList.add("hidden");

                        // Reload chat.js
                        const oldScript = document.querySelector(
                          "script[data-chat-script]"
                        );
                        if (oldScript) oldScript.remove();
                        const newScript = document.createElement("script");
                        newScript.src = "{% static 'assets/js/chat.js' %}";
                        newScript.setAttribute("data-chat-script", "true");
                        document.body.appendChild(newScript);
                      });
                  }
                });
              }

              // Click outside to close
              document.addEventListener("click", (e) => {
                if (
                  !chatSection.contains(e.target) &&
                  !e.target.closest("#message-float-button")
                ) {
                  chatSection.classList.add("hidden");
                }
                if (!chatPopup.contains(e.target)) {
                  chatPopup.classList.add("hidden");
                }
              });
            });
          </script>

          <!------- END OF MESSAGES ------->
          <script>
            // Toggle Message List Popup
            document
              .getElementById("messages-notifications")
              .addEventListener("click", () => {
                const chatSection = document.getElementById("chat-section");
                chatSection.classList.toggle("hidden");

                // Optional: hide chat popup when opening message list
                document.getElementById("chat-popup").classList.add("hidden");
              });

            // When a user clicks a message -> load chat dynamically into chat-popup
            document.querySelectorAll(".message").forEach((el) => {
              el.addEventListener("click", function () {
                const receiverId = this.dataset.userId;

                fetch(`/chat/${receiverId}/`)
                  .then((res) => res.text())
                  .then((html) => {
                    const chatPopup = document.getElementById("chat-popup");
                    chatPopup.innerHTML = html;
                    chatPopup.classList.remove("hidden");

                    // Hide message list popup
                    document
                      .getElementById("chat-section")
                      .classList.add("hidden");

                    // Remove old chat.js if exists
                    const oldScript = document.querySelector(
                      "script[data-chat-script]"
                    );
                    if (oldScript) oldScript.remove();

                    // Inject chat.js script
                    const script = document.createElement("script");
                    script.src = "{% static 'assets/js/chat.js' %}";
                    script.setAttribute("data-chat-script", "true");
                    document.body.appendChild(script);
                  })
                  .catch((err) => console.error("Failed to load chat:", err));
              });
            });
          </script>

          {% include "friend_request_index.html" %}
          <script>
            // Accept or decline friend request
            document.querySelectorAll(".request").forEach((request) => {
              const acceptBtn = request.querySelector(".btn-primary");
              const declineBtn = request.querySelector(
                ".btn:not(.btn-primary)"
              );
              const requestId = request.dataset.requestId;

              acceptBtn?.addEventListener("click", () => {
                fetch(`/friend-request/respond/${requestId}/`, {
                  method: "POST",
                  headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: "action=accept",
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.status === "accepted") request.remove();
                  });
              });

              declineBtn?.addEventListener("click", () => {
                fetch(`/friend-request/respond/${requestId}/`, {
                  method: "POST",
                  headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: "action=decline",
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.status === "declined") request.remove();
                  });
              });
            });

            // CSRF helper
            function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(
                      cookie.substring(name.length + 1)
                    );
                    break;
                  }
                }
              }
              return cookieValue;
            }
          </script>
        </div>
        <!----------------- END OF RIGHT -------------------->
      </div>
    </main>

    <!----------------- THEME CUSTOMIZATION -------------------->
    <div class="customize-theme">
      <div class="card">
        <h2>Customize your view</h2>
        <p class="text-muted">Manage your font size, color, and background</p>

        <!----------- FONT SIZE ----------->
        <div class="font-size">
          <h4>Font Size</h4>
          <div>
            <h6>Aa</h6>
            <div class="choose-size">
              <span class="font-size-1"></span>
              <span class="font-size-2 active"></span>
              <span class="font-size-3"></span>
              <span class="font-size-4"></span>
              <span class="font-size-5"></span>
            </div>
            <h3>Aa</h3>
          </div>
        </div>

        <!----------- PRIMARY COLORS ----------->
        <div class="color">
          <h4>Color</h4>
          <div class="choose-color">
            <span class="color-1 active"></span>
            <span class="color-2"></span>
            <span class="color-3"></span>
            <span class="color-4"></span>
            <span class="color-5"></span>
          </div>
        </div>

        <!----------- BACKGROUND COLORS ----------->
        <div class="background">
          <h4>Background</h4>
          <div class="choose-bg">
            <div class="bg-1 active">
              <span></span>
              <h5 for="bg-1">Light</h5>
            </div>
            <div class="bg-2">
              <span></span>
              <h5 for="bg-2">Dim</h5>
            </div>
            <div class="bg-3">
              <span></span>
              <h5 for="bg-3">Dark</h5>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="popup" class="popup">
      <div class="popup-content">
        <span id="close-popup" class="close" aria-label="Close Popup"
          >&times;</span
        >
        <h2>Unlock Your PerfectMatch Potential with Diamonds!</h2>
        <p>
          Diamonds are your key to a truly enhanced experience on PerfectMatch.
          When you buy diamonds, you gain access to exclusive features and
          benefits:
        </p>
        <ul class="benefits-list">
          <li>
            <i class="fas fa-hand-holding-usd"></i>
            <strong>Lowest Prices</strong>: Enjoy special discounts on future
            diamond purchases!
          </li>
          <li>
            <i class="fas fa-heart"></i>
            <strong>Match with Ease</strong>: Use diamonds to instantly match
            with profiles you admire.
          </li>
          <li>
            <i class="fas fa-sync-alt"></i>
            <strong>Unlimited Swipes</strong>: Get more swipes to discover even
            more potential soulmates.
          </li>
        </ul>
        <p>
          Ready to elevate your PerfectMatch journey? Buy diamonds now and start
          experiencing the difference!
        </p>
        <button id="buy-diamonds-btn-from-notice" class="btn btn-primary">
          Buy Diamonds Now!
        </button>
      </div>
    </div>
    <!--end of payment integration----->
  </body>
  <script src="{%static 'assets/js/new.js'%}"></script>
  <script src="{%static 'assets/js/stories.js'%}"></script>
  <script src="{%static 'assets/js/comment.js'%}"></script>

  <script>
    const storyImages = [
      "{% static 'assets/images/maico.jpg' %}",
      "{% static 'assets/images/yan.png' %}",
      "{% static 'assets/images/angel.png' %}",
      "{% static 'assets/images/skylar.jpg' %}",
      "{% static 'assets/images/profile-2.jpg' %}",
      "{% static 'assets/images/story-6.jpg' %}",
    ];
  </script>
  <!--diamond purchase js-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      // --- Elements for the Diamond Benefits Notice (using original popup IDs) ---
      const benefitsNoticePopup = $("#popup"); // This is now the benefits notice
      const closeBenefitsNoticeBtn = $("#close-popup"); // Close button for the benefits notice
      const buyDiamondsBtnFromNotice = $("#buy-diamonds-btn-from-notice"); // Button inside the benefits notice

      // --- Elements for the Navbar Button and NEW Diamond Purchase Modal ---
      const buyDiamondsBtnNav = $("#buy-diamonds-btn"); // The button in the nav
      const diamondPurchaseModal = $("#diamondPurchaseModal"); // A NEW, separate modal for purchase
      const closePurchaseModalBtn = $("#close-purchase-modal"); // Close button for purchase modal

      // Elements for the quantity selector within the purchase modal (ensure these IDs are unique to that modal)
      const incrementDiamondsBtn = $("#increment-diamonds");
      const decrementDiamondsBtn = $("#decrement-diamonds");
      const diamondAmountInput = $("#diamond-amount");
      const diamondPriceSpan = $("#diamond-price");
      const buyDiamondsNowButton = $("#buy-diamonds-now-button");
      const paymentMessage = $("#payment-message");
      const userDiamondCount = $("#user-diamond-count"); // Assuming this is in your nav

      // Define tiered pricing and a base rate for non-tier amounts (same as before)
      const pricingTiers = {
        10: 15.0, // 10 diamonds for 15 PHP
        20: 25.0, // 20 diamonds for 25 PHP
        50: 50.0, // 50 diamonds for 50 PHP
        100: 90.0, // 100 diamonds for 90 PHP
        200: 160.0, // 200 diamonds for 160 PHP
        500: 350.0, // 500 diamonds for 350 PHP
        1000: 600.0, // 1000 diamonds for 600 PHP
      };
      const baseRatePerDiamond = 1.5;

      function calculatePrice(diamonds) {
        if (pricingTiers.hasOwnProperty(diamonds)) {
          return pricingTiers[diamonds].toFixed(2);
        } else {
          return (diamonds * baseRatePerDiamond).toFixed(2);
        }
      }

      // Function to update diamond amount and price display for the purchase modal
      function updateDiamondDisplay() {
        let currentDiamonds = parseInt(diamondAmountInput.val());
        let currentPrice = calculatePrice(currentDiamonds);
        diamondPriceSpan.text(currentPrice);
      }

      // Initialize display for the purchase modal (only if it exists)
      if (diamondAmountInput.length) {
        // Check if the purchase modal elements exist
        updateDiamondDisplay();
      }

      // --- Event Listeners for the Diamond Benefits Notice (using #popup) ---

      // Example: Open the Benefits Notice automatically after a short delay on page load
      // You can also trigger this from another button, or on first visit etc.

      // Button inside Benefits Notice to open the NEW Diamond Purchase Modal
      buyDiamondsBtnFromNotice.on("click", function () {
        benefitsNoticePopup.css("display", "none"); // Close the benefits notice
        diamondPurchaseModal.css("display", "block"); // Open the purchase modal
        paymentMessage.hide().text(""); // Clear any previous messages in purchase modal
        diamondAmountInput.val(10); // Reset purchase modal to first tier
        updateDiamondDisplay();
      });

      // --- Event Listeners for the Navbar "Buy Diamonds" Button (now opens purchase modal directly) ---
      buyDiamondsBtnNav.on("click", function () {
        diamondPurchaseModal.css("display", "block");
        paymentMessage.hide().text(""); // Clear any previous messages in purchase modal
        diamondAmountInput.val(10); // Reset purchase modal to first tier
        updateDiamondDisplay();
      });

      // --- Event Listeners for the NEW Diamond Purchase Modal ---

      // Close the Diamond Purchase Modal
      closePurchaseModalBtn.on("click", function () {
        diamondPurchaseModal.css("display", "none");
      });

      // Close the purchase modal if user clicks outside of it
      $(window).on("click", function (event) {
        if ($(event.target).is(diamondPurchaseModal)) {
          diamondPurchaseModal.css("display", "none");
        }
      });

      // Diamond Quantity Control for Purchase Modal
      incrementDiamondsBtn.on("click", function () {
        let currentDiamonds = parseInt(diamondAmountInput.val()) || 0;
        let newDiamonds = currentDiamonds + 10;
        diamondAmountInput.val(newDiamonds);
        updateDiamondDisplay();
      });

      decrementDiamondsBtn.on("click", function () {
        let currentDiamonds = parseInt(diamondAmountInput.val()) || 10;
        let newDiamonds = currentDiamonds - 10;
        if (newDiamonds >= 10) {
          diamondAmountInput.val(newDiamonds);
          updateDiamondDisplay();
        }
      });

      // AJAX Payment Integration for Purchase Modal
      buyDiamondsNowButton.on("click", function () {
        const diamondsToBuy = parseInt(diamondAmountInput.val());
        const priceToPay = parseFloat(diamondPriceSpan.text());

        buyDiamondsNowButton.prop("disabled", true).text("Processing...");
        paymentMessage.hide().removeClass("success error");

        $.ajax({
          url: "/buy_diamonds/",
          method: "POST",
          data: {
            diamonds: diamondsToBuy,
            price: priceToPay,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function (response) {
            if (response.success) {
              paymentMessage.text(
                "Payment successful! You received " +
                  diamondsToBuy +
                  " diamonds."
              );
              paymentMessage.css("color", "green").addClass("success").show();
              userDiamondCount.text(response.new_diamond_count);
              setTimeout(() => {
                diamondPurchaseModal.css("display", "none");
                buyDiamondsNowButton.prop("disabled", false).text("Pay Now");
              }, 1500);
            } else {
              paymentMessage.text(
                "Payment failed: " +
                  (response.message || "An unknown error occurred.")
              );
              paymentMessage.css("color", "red").addClass("error").show();
              buyDiamondsNowButton.prop("disabled", false).text("Pay Now");
            }
          },
          error: function (xhr, status, error) {
            paymentMessage.text(
              "An error occurred during payment. Please try again."
            );
            paymentMessage.css("color", "red").addClass("error").show();
            buyDiamondsNowButton.prop("disabled", false).text("Pay Now");
            console.error("AJAX Error:", status, error);
            console.error("Response Text:", xhr.responseText);
          },
        });
      });
    });
  </script>

  <!--bookmarks js-->
</html>
